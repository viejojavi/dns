#!/bin/bash

# Configuraci贸n de variables
USUARIO="XXXXXXXXX"
CONTRASENA="XXXXXXXXX"
URL_MINTIC="https://archivo.mintic.gov.co/ubpi/620/articles-182605_archivo_txt.txt"
URL_COLJUEGOS="https://archivo.mintic.gov.co/ubpi/664/articles-180527_archivo_txt.txt"
ARCHIVO_MINTIC="mintic.txt"
ARCHIVO_COLJUEGOS="coljuegos.txt"
ARCHIVO_DOMINIOS="dominios_mintic.txt"
LOG_FILE="/var/log/descarga_dominios.log"

# Funci贸n para registrar logs
log() {
  echo "$(date) - $1" >> "$LOG_FILE"
}

# Descargar archivos
descargar_archivos() {
  log "Iniciando descarga de archivos."
  wget --user="$USUARIO" --password="$CONTRASENA" "$URL_MINTIC" -O "$ARCHIVO_MINTIC"
  if [ $? -ne 0 ]; then
    log "Error al descargar $ARCHIVO_MINTIC."
    return 1
  fi
  wget --user="$USUARIO" --password="$CONTRASENA" "$URL_COLJUEGOS" -O "$ARCHIVO_COLJUEGOS"
  if [ $? -ne 0 ]; then
    log "Error al descargar $ARCHIVO_COLJUEGOS."
    return 1
  fi
  log "Descarga de archivos completada."
  return 0
}

# Extraer dominios de mintic.txt
extraer_dominios() {
  log "Iniciando extracci贸n de dominios de $ARCHIVO_MINTIC."
  while IFS= read -r url; do
    if [[ "$url" =~ ^(https?:\/\/)?([a-zA-Z0-9.-]+\.[a-zA-Z]{2,}) ]]; then
      dominio="${BASH_REMATCH[2]}"
      echo "$dominio"
    fi
  done < "$ARCHIVO_MINTIC" | sort -u > "$ARCHIVO_DOMINIOS"
  if [ $? -ne 0 ]; then
    log "Error al extraer dominios."
    return 1
  fi
  log "Extracci贸n de dominios completada. Dominios guardados en $ARCHIVO_DOMINIOS."
  return 0
}

# Ejecutar funciones
descargar_archivos
if [ $? -eq 0 ]; then
  extraer_dominios
fi

# Fin del script
log "Script finalizado."
